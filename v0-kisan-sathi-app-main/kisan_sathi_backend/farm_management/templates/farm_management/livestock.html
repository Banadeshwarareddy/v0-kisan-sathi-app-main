{% extends 'farm_management/base.html' %}

{% block title %}Livestock - Farm Management{% endblock %}

{% block content %}
<div id="alerts-container"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-horse me-2"></i>Livestock Management</h2>
    <div>
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#vaccinationModal">
            <i class="fas fa-syringe me-1"></i>Add Vaccination
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#livestockModal">
            <i class="fas fa-plus me-1"></i>Add Livestock
        </button>
    </div>
</div>

<!-- Livestock Table -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-list me-2"></i>Livestock Records</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Tag Number</th>
                        <th>Type</th>
                        <th>Breed</th>
                        <th>Age (Months)</th>
                        <th>Weight (kg)</th>
                        <th>Health Status</th>
                        <th>Purchase Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="livestockTableBody">
                    <tr>
                        <td colspan="8" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Vaccination Records -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-syringe me-2"></i>Vaccination Records</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Livestock</th>
                        <th>Vaccine</th>
                        <th>Date</th>
                        <th>Next Due</th>
                        <th>Veterinarian</th>
                        <th>Cost</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="vaccinationTableBody">
                    <tr>
                        <td colspan="7" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Livestock Modal -->
<div class="modal fade" id="livestockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Livestock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="livestockForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Livestock Type *</label>
                                <select class="form-select" id="livestockType" required>
                                    <option value="">Select Type</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Tag Number *</label>
                                <input type="text" class="form-control" id="tagNumber" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Breed</label>
                                <input type="text" class="form-control" id="breed">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Age (Months)</label>
                                <input type="number" class="form-control" id="ageMonths" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Weight (kg)</label>
                                <input type="number" class="form-control" id="weight" step="0.1" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Health Status</label>
                                <select class="form-select" id="healthStatus">
                                    <option value="healthy">Healthy</option>
                                    <option value="sick">Sick</option>
                                    <option value="under_treatment">Under Treatment</option>
                                    <option value="quarantine">Quarantine</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Purchase Date *</label>
                                <input type="date" class="form-control" id="purchaseDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Purchase Price (₹)</label>
                                <input type="number" class="form-control" id="purchasePrice" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="livestockNotes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Livestock</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Vaccination Modal -->
<div class="modal fade" id="vaccinationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Vaccination Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="vaccinationForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Livestock *</label>
                        <select class="form-select" id="vaccinationLivestock" required>
                            <option value="">Select Livestock</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Vaccine Name *</label>
                        <input type="text" class="form-control" id="vaccineName" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Vaccination Date *</label>
                                <input type="date" class="form-control" id="vaccinationDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Next Due Date</label>
                                <input type="date" class="form-control" id="nextDueDate">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Veterinarian</label>
                                <input type="text" class="form-control" id="veterinarian">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cost (₹)</label>
                                <input type="number" class="form-control" id="vaccinationCost" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="vaccinationNotes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Vaccination</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    loadLivestockTypes();
    loadLivestock();
    loadVaccinations();
    
    $('#livestockForm').on('submit', function(e) {
        e.preventDefault();
        saveLivestock();
    });
    
    $('#vaccinationForm').on('submit', function(e) {
        e.preventDefault();
        saveVaccination();
    });
});

function loadLivestockTypes() {
    $.get(API_BASE_URL + 'livestock-types/')
        .done(function(data) {
            let options = '<option value="">Select Type</option>';
            data.forEach(type => {
                options += `<option value="${type.id}">${type.name}</option>`;
            });
            $('#livestockType').html(options);
        });
}

function loadLivestock() {
    $.get(API_BASE_URL + 'livestock/')
        .done(function(data) {
            displayLivestock(data.results || data);
            loadLivestockForVaccination(data.results || data);
        });
}

function loadVaccinations() {
    $.get(API_BASE_URL + 'vaccinations/')
        .done(function(data) {
            displayVaccinations(data.results || data);
        });
}

function displayLivestock(livestock) {
    let html = '';
    if (livestock.length === 0) {
        html = '<tr><td colspan="8" class="text-center text-muted">No livestock records found</td></tr>';
    } else {
        livestock.forEach(animal => {
            const healthBadge = getHealthBadge(animal.health_status);
            html += `
                <tr>
                    <td><strong>${animal.tag_number}</strong></td>
                    <td>${animal.livestock_type_name}</td>
                    <td>${animal.breed || '-'}</td>
                    <td>${animal.age_months || '-'}</td>
                    <td>${animal.weight || '-'}</td>
                    <td>${healthBadge}</td>
                    <td>${formatDate(animal.purchase_date)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLivestock(${animal.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    $('#livestockTableBody').html(html);
}

function displayVaccinations(vaccinations) {
    let html = '';
    if (vaccinations.length === 0) {
        html = '<tr><td colspan="7" class="text-center text-muted">No vaccination records found</td></tr>';
    } else {
        vaccinations.forEach(vaccination => {
            html += `
                <tr>
                    <td>${vaccination.livestock_tag}</td>
                    <td>${vaccination.vaccine_name}</td>
                    <td>${formatDate(vaccination.vaccination_date)}</td>
                    <td>${vaccination.next_due_date ? formatDate(vaccination.next_due_date) : '-'}</td>
                    <td>${vaccination.veterinarian || '-'}</td>
                    <td>${vaccination.cost ? formatCurrency(vaccination.cost) : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteVaccination(${vaccination.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    $('#vaccinationTableBody').html(html);
}

function loadLivestockForVaccination(livestock) {
    let options = '<option value="">Select Livestock</option>';
    livestock.forEach(animal => {
        options += `<option value="${animal.id}">${animal.tag_number} (${animal.livestock_type_name})</option>`;
    });
    $('#vaccinationLivestock').html(options);
}

function getHealthBadge(status) {
    const badges = {
        'healthy': '<span class="badge bg-success">Healthy</span>',
        'sick': '<span class="badge bg-danger">Sick</span>',
        'under_treatment': '<span class="badge bg-warning">Under Treatment</span>',
        'quarantine': '<span class="badge bg-secondary">Quarantine</span>'
    };
    return badges[status] || status;
}

function saveLivestock() {
    const livestockData = {
        livestock_type: $('#livestockType').val(),
        tag_number: $('#tagNumber').val(),
        breed: $('#breed').val(),
        age_months: $('#ageMonths').val() || null,
        weight: $('#weight').val() || null,
        health_status: $('#healthStatus').val(),
        purchase_date: $('#purchaseDate').val(),
        purchase_price: $('#purchasePrice').val() || null,
        notes: $('#livestockNotes').val()
    };
    
    $.ajax({
        url: API_BASE_URL + 'livestock/',
        method: 'POST',
        data: JSON.stringify(livestockData),
        contentType: 'application/json'
    })
    .done(function() {
        $('#livestockModal').modal('hide');
        loadLivestock();
        showAlert('Livestock added successfully', 'success');
        $('#livestockForm')[0].reset();
    })
    .fail(function(xhr) {
        const errors = xhr.responseJSON;
        let errorMessage = 'Failed to save livestock';
        if (errors) {
            errorMessage += ': ' + Object.values(errors).flat().join(', ');
        }
        showAlert(errorMessage, 'danger');
    });
}

function saveVaccination() {
    const vaccinationData = {
        livestock: $('#vaccinationLivestock').val(),
        vaccine_name: $('#vaccineName').val(),
        vaccination_date: $('#vaccinationDate').val(),
        next_due_date: $('#nextDueDate').val() || null,
        veterinarian: $('#veterinarian').val(),
        cost: $('#vaccinationCost').val() || null,
        notes: $('#vaccinationNotes').val()
    };
    
    $.ajax({
        url: API_BASE_URL + 'vaccinations/',
        method: 'POST',
        data: JSON.stringify(vaccinationData),
        contentType: 'application/json'
    })
    .done(function() {
        $('#vaccinationModal').modal('hide');
        loadVaccinations();
        showAlert('Vaccination record added successfully', 'success');
        $('#vaccinationForm')[0].reset();
    })
    .fail(function(xhr) {
        const errors = xhr.responseJSON;
        let errorMessage = 'Failed to save vaccination record';
        if (errors) {
            errorMessage += ': ' + Object.values(errors).flat().join(', ');
        }
        showAlert(errorMessage, 'danger');
    });
}

function deleteLivestock(id) {
    if (confirm('Are you sure you want to delete this livestock record?')) {
        $.ajax({
            url: API_BASE_URL + 'livestock/' + id + '/',
            method: 'DELETE'
        })
        .done(function() {
            loadLivestock();
            showAlert('Livestock deleted successfully', 'success');
        })
        .fail(function() {
            showAlert('Failed to delete livestock', 'danger');
        });
    }
}

function deleteVaccination(id) {
    if (confirm('Are you sure you want to delete this vaccination record?')) {
        $.ajax({
            url: API_BASE_URL + 'vaccinations/' + id + '/',
            method: 'DELETE'
        })
        .done(function() {
            loadVaccinations();
            showAlert('Vaccination record deleted successfully', 'success');
        })
        .fail(function() {
            showAlert('Failed to delete vaccination record', 'danger');
        });
    }
}
</script>
{% endblock %}