{% extends 'farm_management/base.html' %}

{% block title %}Crop Planning - Farm Management{% endblock %}

{% block content %}
<div id="alerts-container"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-calendar-alt me-2"></i>Crop Planning</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cropPlanModal">
        <i class="fas fa-plus me-1"></i>Add Crop Plan
    </button>
</div>

<!-- Status Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Planned</h6>
                        <h4 class="card-title text-secondary" id="planned-count">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clipboard-list fa-2x text-secondary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Planted</h6>
                        <h4 class="card-title text-primary" id="planted-count">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-seedling fa-2x text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Growing</h6>
                        <h4 class="card-title text-success" id="growing-count">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-leaf fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Harvested</h6>
                        <h4 class="card-title text-warning" id="harvested-count">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-warehouse fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Crop</label>
                <select class="form-select" id="cropFilter">
                    <option value="">All Crops</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="planned">Planned</option>
                    <option value="planted">Planted</option>
                    <option value="growing">Growing</option>
                    <option value="harvested">Harvested</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Season</label>
                <select class="form-select" id="seasonFilter">
                    <option value="">All Seasons</option>
                    <option value="kharif">Kharif</option>
                    <option value="rabi">Rabi</option>
                    <option value="zaid">Zaid</option>
                    <option value="perennial">Perennial</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button class="btn btn-outline-primary" onclick="applyFilters()">
                        <i class="fas fa-filter me-1"></i>Filter
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Crop Plans Table -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-list me-2"></i>Crop Plans</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Crop</th>
                        <th>Area</th>
                        <th>Planting Date</th>
                        <th>Expected Harvest</th>
                        <th>Est. Cost</th>
                        <th>Est. Revenue</th>
                        <th>Est. Profit</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="cropPlansTableBody">
                    <tr>
                        <td colspan="9" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav>
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
    </div>
</div>

<!-- Add/Edit Crop Plan Modal -->
<div class="modal fade" id="cropPlanModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropPlanModalTitle">Add Crop Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="cropPlanForm">
                <div class="modal-body">
                    <input type="hidden" id="cropPlanId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Crop *</label>
                                <select class="form-select" id="crop" required>
                                    <option value="">Select Crop</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Status *</label>
                                <select class="form-select" id="status" required>
                                    <option value="planned">Planned</option>
                                    <option value="planted">Planted</option>
                                    <option value="growing">Growing</option>
                                    <option value="harvested">Harvested</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Planned Area *</label>
                                <input type="number" class="form-control" id="plannedArea" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Area Unit *</label>
                                <select class="form-select" id="areaUnit" required>
                                    <option value="acre">Acre</option>
                                    <option value="hectare">Hectare</option>
                                    <option value="bigha">Bigha</option>
                                    <option value="katha">Katha</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Planting Date *</label>
                                <input type="date" class="form-control" id="plantingDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Expected Harvest Date *</label>
                                <input type="date" class="form-control" id="expectedHarvestDate" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Estimated Yield</label>
                                <input type="number" class="form-control" id="estimatedYield" step="0.01" min="0">
                                <small class="form-text text-muted">In quintals</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Estimated Cost (₹)</label>
                                <input type="number" class="form-control" id="estimatedCost" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Estimated Revenue (₹)</label>
                                <input type="number" class="form-control" id="estimatedRevenue" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Plan</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};

$(document).ready(function() {
    loadCrops();
    loadCropPlans();
    loadCropPlanStats();
    
    // Form submission
    $('#cropPlanForm').on('submit', function(e) {
        e.preventDefault();
        saveCropPlan();
    });
});

function loadCrops() {
    $.get(API_BASE_URL + 'crops/')
        .done(function(data) {
            let options = '<option value="">Select Crop</option>';
            let filterOptions = '<option value="">All Crops</option>';
            
            data.forEach(crop => {
                const cropName = crop.variety ? `${crop.name} (${crop.variety})` : crop.name;
                options += `<option value="${crop.id}">${cropName}</option>`;
                filterOptions += `<option value="${crop.id}">${cropName}</option>`;
            });
            
            $('#crop').html(options);
            $('#cropFilter').html(filterOptions);
        })
        .fail(function() {
            showAlert('Failed to load crops', 'danger');
        });
}

function loadCropPlans(page = 1) {
    let url = API_BASE_URL + 'crop-plans/?page=' + page;
    
    // Add filters
    if (currentFilters.crop) {
        url += '&crop=' + currentFilters.crop;
    }
    if (currentFilters.status) {
        url += '&status=' + currentFilters.status;
    }
    
    $.get(url)
        .done(function(data) {
            displayCropPlans(data.results || data);
            updatePagination(data);
        })
        .fail(function() {
            showAlert('Failed to load crop plans', 'danger');
        });
}

function loadCropPlanStats() {
    $.get(API_BASE_URL + 'crop-plans/')
        .done(function(data) {
            const plans = data.results || data;
            const stats = {
                planned: 0,
                planted: 0,
                growing: 0,
                harvested: 0
            };
            
            plans.forEach(plan => {
                if (stats.hasOwnProperty(plan.status)) {
                    stats[plan.status]++;
                }
            });
            
            $('#planned-count').text(stats.planned);
            $('#planted-count').text(stats.planted);
            $('#growing-count').text(stats.growing);
            $('#harvested-count').text(stats.harvested);
        });
}

function displayCropPlans(plans) {
    let html = '';
    
    if (plans.length === 0) {
        html = '<tr><td colspan="9" class="text-center text-muted">No crop plans found</td></tr>';
    } else {
        plans.forEach(plan => {
            const statusBadge = getStatusBadge(plan.status);
            const profit = plan.estimated_profit ? formatCurrency(plan.estimated_profit) : '-';
            
            html += `
                <tr>
                    <td>${plan.crop_name}</td>
                    <td>${plan.planned_area} ${plan.area_unit}</td>
                    <td>${formatDate(plan.planting_date)}</td>
                    <td>${formatDate(plan.expected_harvest_date)}</td>
                    <td>${plan.estimated_cost ? formatCurrency(plan.estimated_cost) : '-'}</td>
                    <td>${plan.estimated_revenue ? formatCurrency(plan.estimated_revenue) : '-'}</td>
                    <td class="${plan.estimated_profit >= 0 ? 'text-success' : 'text-danger'}">${profit}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editCropPlan(${plan.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="updateStatus(${plan.id})" title="Update Status">
                            <i class="fas fa-sync"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCropPlan(${plan.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    $('#cropPlansTableBody').html(html);
}

function getStatusBadge(status) {
    const badges = {
        'planned': '<span class="badge bg-secondary">Planned</span>',
        'planted': '<span class="badge bg-primary">Planted</span>',
        'growing': '<span class="badge bg-success">Growing</span>',
        'harvested': '<span class="badge bg-warning">Harvested</span>',
        'cancelled': '<span class="badge bg-danger">Cancelled</span>'
    };
    return badges[status] || status;
}

function updatePagination(data) {
    let html = '';
    if (data.previous) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadCropPlans(${currentPage - 1})">Previous</a></li>`;
    }
    html += `<li class="page-item active"><a class="page-link" href="#">${currentPage}</a></li>`;
    if (data.next) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadCropPlans(${currentPage + 1})">Next</a></li>`;
    }
    $('#pagination').html(html);
}

function applyFilters() {
    currentFilters = {
        crop: $('#cropFilter').val(),
        status: $('#statusFilter').val()
    };
    currentPage = 1;
    loadCropPlans();
}

function clearFilters() {
    $('#cropFilter').val('');
    $('#statusFilter').val('');
    $('#seasonFilter').val('');
    currentFilters = {};
    currentPage = 1;
    loadCropPlans();
}

function saveCropPlan() {
    const planData = {
        crop: $('#crop').val(),
        planned_area: $('#plannedArea').val(),
        area_unit: $('#areaUnit').val(),
        planting_date: $('#plantingDate').val(),
        expected_harvest_date: $('#expectedHarvestDate').val(),
        estimated_yield: $('#estimatedYield').val() || null,
        estimated_cost: $('#estimatedCost').val() || null,
        estimated_revenue: $('#estimatedRevenue').val() || null,
        status: $('#status').val(),
        notes: $('#notes').val()
    };
    
    const planId = $('#cropPlanId').val();
    const url = planId ? 
        API_BASE_URL + 'crop-plans/' + planId + '/' : 
        API_BASE_URL + 'crop-plans/';
    
    const method = planId ? 'PUT' : 'POST';
    
    $.ajax({
        url: url,
        method: method,
        data: JSON.stringify(planData),
        contentType: 'application/json'
    })
    .done(function() {
        $('#cropPlanModal').modal('hide');
        loadCropPlans(currentPage);
        loadCropPlanStats();
        showAlert('Crop plan saved successfully', 'success');
        resetForm();
    })
    .fail(function(xhr) {
        const errors = xhr.responseJSON;
        let errorMessage = 'Failed to save crop plan';
        if (errors) {
            errorMessage += ': ' + Object.values(errors).flat().join(', ');
        }
        showAlert(errorMessage, 'danger');
    });
}

function editCropPlan(id) {
    $.get(API_BASE_URL + 'crop-plans/' + id + '/')
        .done(function(plan) {
            $('#cropPlanId').val(plan.id);
            $('#crop').val(plan.crop);
            $('#plannedArea').val(plan.planned_area);
            $('#areaUnit').val(plan.area_unit);
            $('#plantingDate').val(plan.planting_date);
            $('#expectedHarvestDate').val(plan.expected_harvest_date);
            $('#estimatedYield').val(plan.estimated_yield);
            $('#estimatedCost').val(plan.estimated_cost);
            $('#estimatedRevenue').val(plan.estimated_revenue);
            $('#status').val(plan.status);
            $('#notes').val(plan.notes);
            
            $('#cropPlanModalTitle').text('Edit Crop Plan');
            $('#cropPlanModal').modal('show');
        })
        .fail(function() {
            showAlert('Failed to load crop plan details', 'danger');
        });
}

function updateStatus(id) {
    const newStatus = prompt('Enter new status (planned/planted/growing/harvested/cancelled):');
    if (newStatus && ['planned', 'planted', 'growing', 'harvested', 'cancelled'].includes(newStatus)) {
        $.ajax({
            url: API_BASE_URL + 'crop-plans/' + id + '/',
            method: 'PATCH',
            data: JSON.stringify({status: newStatus}),
            contentType: 'application/json'
        })
        .done(function() {
            loadCropPlans(currentPage);
            loadCropPlanStats();
            showAlert('Status updated successfully', 'success');
        })
        .fail(function() {
            showAlert('Failed to update status', 'danger');
        });
    }
}

function deleteCropPlan(id) {
    if (confirm('Are you sure you want to delete this crop plan?')) {
        $.ajax({
            url: API_BASE_URL + 'crop-plans/' + id + '/',
            method: 'DELETE'
        })
        .done(function() {
            loadCropPlans(currentPage);
            loadCropPlanStats();
            showAlert('Crop plan deleted successfully', 'success');
        })
        .fail(function() {
            showAlert('Failed to delete crop plan', 'danger');
        });
    }
}

function resetForm() {
    $('#cropPlanForm')[0].reset();
    $('#cropPlanId').val('');
    $('#cropPlanModalTitle').text('Add Crop Plan');
}

// Reset form when modal is hidden
$('#cropPlanModal').on('hidden.bs.modal', function() {
    resetForm();
});
</script>
{% endblock %}