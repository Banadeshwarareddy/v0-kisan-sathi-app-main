{% extends 'farm_management/base.html' %}

{% block title %}Loans & EMI - Farm Management{% endblock %}

{% block content %}
<div id="alerts-container"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-university me-2"></i>Loans & EMI Management</h2>
    <div>
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#emiModal">
            <i class="fas fa-money-check me-1"></i>Add EMI Payment
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loanModal">
            <i class="fas fa-plus me-1"></i>Add Loan
        </button>
    </div>
</div>

<!-- Loan Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Active Loans</h6>
                        <h4 class="card-title text-primary" id="active-loans-count">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-university fa-2x text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Total Outstanding</h6>
                        <h4 class="card-title text-danger" id="total-outstanding">₹0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Monthly EMI</h6>
                        <h4 class="card-title text-warning" id="monthly-emi">₹0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-alt fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Completed Loans</h6>
                        <h4 class="card-title text-success" id="completed-loans">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loans Table -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-list me-2"></i>Loan Records</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Lender</th>
                        <th>Type</th>
                        <th>Principal Amount</th>
                        <th>Interest Rate</th>
                        <th>EMI Amount</th>
                        <th>Remaining Amount</th>
                        <th>Loan Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="loansTableBody">
                    <tr>
                        <td colspan="9" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- EMI Payments Table -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-money-check me-2"></i>EMI Payment History</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Loan</th>
                        <th>Payment Date</th>
                        <th>Amount Paid</th>
                        <th>Principal</th>
                        <th>Interest</th>
                        <th>Payment Method</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="emiTableBody">
                    <tr>
                        <td colspan="7" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Loan Modal -->
<div class="modal fade" id="loanModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Loan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="loanForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Lender Name *</label>
                                <input type="text" class="form-control" id="lenderName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Loan Type *</label>
                                <select class="form-select" id="loanType" required>
                                    <option value="crop_loan">Crop Loan</option>
                                    <option value="equipment_loan">Equipment Loan</option>
                                    <option value="personal_loan">Personal Loan</option>
                                    <option value="kisan_credit_card">Kisan Credit Card</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Principal Amount (₹) *</label>
                                <input type="number" class="form-control" id="principalAmount" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Interest Rate (%) *</label>
                                <input type="number" class="form-control" id="interestRate" step="0.01" min="0.01" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Loan Date *</label>
                                <input type="date" class="form-control" id="loanDate" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Tenure (Months) *</label>
                                <input type="number" class="form-control" id="tenureMonths" min="1" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">EMI Amount (₹) *</label>
                                <input type="number" class="form-control" id="emiAmount" step="0.01" min="0.01" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Purpose</label>
                        <textarea class="form-control" id="purpose" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Loan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- EMI Payment Modal -->
<div class="modal fade" id="emiModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add EMI Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="emiForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Loan *</label>
                        <select class="form-select" id="emiLoan" required>
                            <option value="">Select Loan</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Payment Date *</label>
                                <input type="date" class="form-control" id="paymentDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Amount Paid (₹) *</label>
                                <input type="number" class="form-control" id="amountPaid" step="0.01" min="0.01" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Principal Component (₹)</label>
                                <input type="number" class="form-control" id="principalComponent" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Interest Component (₹)</label>
                                <input type="number" class="form-control" id="interestComponent" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Payment Method *</label>
                                <select class="form-select" id="paymentMethod" required>
                                    <option value="cash">Cash</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="cheque">Cheque</option>
                                    <option value="online">Online Payment</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Penalty (₹)</label>
                                <input type="number" class="form-control" id="penalty" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Transaction Reference</label>
                        <input type="text" class="form-control" id="transactionReference">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="emiNotes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    loadLoans();
    loadEMIPayments();
    loadLoanStats();
    
    // Set default date to today
    $('#paymentDate').val(new Date().toISOString().split('T')[0]);
    
    $('#loanForm').on('submit', function(e) {
        e.preventDefault();
        saveLoan();
    });
    
    $('#emiForm').on('submit', function(e) {
        e.preventDefault();
        saveEMIPayment();
    });
});

function loadLoans() {
    $.get(API_BASE_URL + 'loans/')
        .done(function(data) {
            displayLoans(data.results || data);
            loadLoansForEMI(data.results || data);
        });
}

function loadEMIPayments() {
    $.get(API_BASE_URL + 'emi-payments/')
        .done(function(data) {
            displayEMIPayments(data.results || data);
        });
}

function loadLoanStats() {
    $.get(API_BASE_URL + 'loans/')
        .done(function(data) {
            const loans = data.results || data;
            let activeCount = 0;
            let completedCount = 0;
            let totalOutstanding = 0;
            let monthlyEMI = 0;
            
            loans.forEach(loan => {
                if (loan.status === 'active') {
                    activeCount++;
                    totalOutstanding += parseFloat(loan.remaining_amount);
                    monthlyEMI += parseFloat(loan.emi_amount);
                } else if (loan.status === 'completed') {
                    completedCount++;
                }
            });
            
            $('#active-loans-count').text(activeCount);
            $('#completed-loans').text(completedCount);
            $('#total-outstanding').text(formatCurrency(totalOutstanding));
            $('#monthly-emi').text(formatCurrency(monthlyEMI));
        });
}

function displayLoans(loans) {
    let html = '';
    if (loans.length === 0) {
        html = '<tr><td colspan="9" class="text-center text-muted">No loan records found</td></tr>';
    } else {
        loans.forEach(loan => {
            const statusBadge = getLoanStatusBadge(loan.status);
            html += `
                <tr>
                    <td><strong>${loan.lender_name}</strong></td>
                    <td>${loan.loan_type.replace('_', ' ').toUpperCase()}</td>
                    <td>${formatCurrency(loan.principal_amount)}</td>
                    <td>${loan.interest_rate}%</td>
                    <td>${formatCurrency(loan.emi_amount)}</td>
                    <td>${formatCurrency(loan.remaining_amount)}</td>
                    <td>${formatDate(loan.loan_date)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-success" onclick="updateLoanStatus(${loan.id})" title="Update Status">
                            <i class="fas fa-sync"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLoan(${loan.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    $('#loansTableBody').html(html);
}

function displayEMIPayments(payments) {
    let html = '';
    if (payments.length === 0) {
        html = '<tr><td colspan="7" class="text-center text-muted">No EMI payment records found</td></tr>';
    } else {
        payments.forEach(payment => {
            html += `
                <tr>
                    <td>${payment.loan_lender}</td>
                    <td>${formatDate(payment.payment_date)}</td>
                    <td>${formatCurrency(payment.amount_paid)}</td>
                    <td>${formatCurrency(payment.principal_component)}</td>
                    <td>${formatCurrency(payment.interest_component)}</td>
                    <td>${payment.payment_method.replace('_', ' ').toUpperCase()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteEMIPayment(${payment.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    $('#emiTableBody').html(html);
}

function loadLoansForEMI(loans) {
    let options = '<option value="">Select Loan</option>';
    loans.filter(loan => loan.status === 'active').forEach(loan => {
        options += `<option value="${loan.id}">${loan.lender_name} - ${loan.loan_type.replace('_', ' ')}</option>`;
    });
    $('#emiLoan').html(options);
}

function getLoanStatusBadge(status) {
    const badges = {
        'active': '<span class="badge bg-primary">Active</span>',
        'completed': '<span class="badge bg-success">Completed</span>',
        'defaulted': '<span class="badge bg-danger">Defaulted</span>'
    };
    return badges[status] || status;
}

function saveLoan() {
    const loanData = {
        lender_name: $('#lenderName').val(),
        loan_type: $('#loanType').val(),
        principal_amount: $('#principalAmount').val(),
        interest_rate: $('#interestRate').val(),
        loan_date: $('#loanDate').val(),
        tenure_months: $('#tenureMonths').val(),
        emi_amount: $('#emiAmount').val(),
        remaining_amount: $('#principalAmount').val(), // Initially same as principal
        purpose: $('#purpose').val()
    };
    
    $.ajax({
        url: API_BASE_URL + 'loans/',
        method: 'POST',
        data: JSON.stringify(loanData),
        contentType: 'application/json'
    })
    .done(function() {
        $('#loanModal').modal('hide');
        loadLoans();
        loadLoanStats();
        showAlert('Loan added successfully', 'success');
        $('#loanForm')[0].reset();
    })
    .fail(function(xhr) {
        const errors = xhr.responseJSON;
        let errorMessage = 'Failed to save loan';
        if (errors) {
            errorMessage += ': ' + Object.values(errors).flat().join(', ');
        }
        showAlert(errorMessage, 'danger');
    });
}

function saveEMIPayment() {
    const emiData = {
        loan: $('#emiLoan').val(),
        payment_date: $('#paymentDate').val(),
        amount_paid: $('#amountPaid').val(),
        principal_component: $('#principalComponent').val() || 0,
        interest_component: $('#interestComponent').val() || 0,
        penalty: $('#penalty').val() || 0,
        payment_method: $('#paymentMethod').val(),
        transaction_reference: $('#transactionReference').val(),
        notes: $('#emiNotes').val()
    };
    
    $.ajax({
        url: API_BASE_URL + 'emi-payments/',
        method: 'POST',
        data: JSON.stringify(emiData),
        contentType: 'application/json'
    })
    .done(function() {
        $('#emiModal').modal('hide');
        loadEMIPayments();
        loadLoans(); // Reload to update remaining amounts
        loadLoanStats();
        showAlert('EMI payment added successfully', 'success');
        $('#emiForm')[0].reset();
        $('#paymentDate').val(new Date().toISOString().split('T')[0]);
    })
    .fail(function(xhr) {
        const errors = xhr.responseJSON;
        let errorMessage = 'Failed to save EMI payment';
        if (errors) {
            errorMessage += ': ' + Object.values(errors).flat().join(', ');
        }
        showAlert(errorMessage, 'danger');
    });
}

function updateLoanStatus(id) {
    const newStatus = prompt('Enter new status (active/completed/defaulted):');
    if (newStatus && ['active', 'completed', 'defaulted'].includes(newStatus)) {
        $.ajax({
            url: API_BASE_URL + 'loans/' + id + '/',
            method: 'PATCH',
            data: JSON.stringify({status: newStatus}),
            contentType: 'application/json'
        })
        .done(function() {
            loadLoans();
            loadLoanStats();
            showAlert('Loan status updated successfully', 'success');
        })
        .fail(function() {
            showAlert('Failed to update loan status', 'danger');
        });
    }
}

function deleteLoan(id) {
    if (confirm('Are you sure you want to delete this loan record?')) {
        $.ajax({
            url: API_BASE_URL + 'loans/' + id + '/',
            method: 'DELETE'
        })
        .done(function() {
            loadLoans();
            loadLoanStats();
            showAlert('Loan deleted successfully', 'success');
        })
        .fail(function() {
            showAlert('Failed to delete loan', 'danger');
        });
    }
}

function deleteEMIPayment(id) {
    if (confirm('Are you sure you want to delete this EMI payment record?')) {
        $.ajax({
            url: API_BASE_URL + 'emi-payments/' + id + '/',
            method: 'DELETE'
        })
        .done(function() {
            loadEMIPayments();
            loadLoans();
            loadLoanStats();
            showAlert('EMI payment deleted successfully', 'success');
        })
        .fail(function() {
            showAlert('Failed to delete EMI payment', 'danger');
        });
    }
}
</script>
{% endblock %}