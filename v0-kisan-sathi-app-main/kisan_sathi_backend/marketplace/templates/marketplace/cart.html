{% extends 'marketplace/base.html' %}
{% load static %}

{% block title %}Shopping Cart - Kisan Marketplace{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 0;">
    <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">Shopping Cart</h1>
    
    <div style="display: grid; grid-template-columns: 1fr 400px; gap: 2rem;">
        <div id="cart-items-container">
            <div style="text-align: center; padding: 4rem;">
                <div class="spinner"></div>
            </div>
        </div>
        
        <div>
            <div style="background: white; padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); position: sticky; top: 100px;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem;">Order Summary</h3>
                
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: var(--text-secondary);">Subtotal</span>
                        <span id="subtotal">â‚¹0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: var(--text-secondary);">Delivery</span>
                        <span id="delivery">â‚¹50.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: var(--text-secondary);">Tax (5%)</span>
                        <span id="tax">â‚¹0.00</span>
                    </div>
                    <div style="border-top: 1px solid var(--border-color); padding-top: 0.75rem; margin-top: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: 700;">
                            <span>Total</span>
                            <span id="total" style="color: var(--primary-color);">â‚¹0.00</span>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-lg" style="width: 100%;" onclick="proceedToCheckout()" id="checkout-btn" disabled>
                    Proceed to Checkout
                </button>
                
                <a href="/marketplace/products/" class="btn btn-outline" style="width: 100%; margin-top: 1rem; text-align: center; display: block;">
                    Continue Shopping
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.cart-item {
    background: white;
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    margin-bottom: 1rem;
    display: flex;
    gap: 1.5rem;
    box-shadow: var(--shadow-sm);
}

.cart-item-image {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: var(--radius-md);
}

.cart-item-details {
    flex: 1;
}

.cart-item-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

@media (max-width: 1024px) {
    .container > div {
        grid-template-columns: 1fr;
    }
}
</style>

{% endblock %}

{% block extra_js %}
<script>
let cartItems = [];

document.addEventListener('DOMContentLoaded', async () => {
    await loadCart();
});

async function loadCart() {
    try {
        const response = await fetchCartSummary();
        cartItems = response.items || [];
        displayCart();
        updateSummary();
    } catch (error) {
        console.error('Error loading cart:', error);
        displayEmptyCart();
    }
}

function displayCart() {
    const container = document.getElementById('cart-items-container');
    
    if (cartItems.length === 0) {
        displayEmptyCart();
        return;
    }
    
    container.innerHTML = cartItems.map(item => `
        <div class="cart-item">
            <img src="${item.product.primary_image_url || getPlaceholderImage(item.product.name)}" 
                 alt="${item.product.name}" 
                 class="cart-item-image"
                 onerror="handleImageError(this)">
            
            <div class="cart-item-details">
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">
                    <a href="/marketplace/products/${item.product.id}/" style="color: inherit; text-decoration: none;">
                        ${item.product.name}
                    </a>
                </h3>
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">
                    ${item.product.farmer_name}
                </p>
                <p style="font-size: 1.25rem; font-weight: 700; color: var(--primary-color);">
                    ${formatPrice(item.unit_price)} / ${item.product.unit}
                </p>
            </div>
            
            <div class="cart-item-actions">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <button class="quantity-btn" onclick="updateQuantity('${item.id}', ${item.quantity - 1})">âˆ’</button>
                    <input type="number" value="${item.quantity}" min="1" 
                           style="width: 60px; text-align: center; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);"
                           onchange="updateQuantity('${item.id}', this.value)">
                    <button class="quantity-btn" onclick="updateQuantity('${item.id}', ${parseFloat(item.quantity) + 1})">+</button>
                </div>
                
                <div style="text-align: right;">
                    <div style="font-weight: 700; font-size: 1.125rem; margin-bottom: 0.5rem;">
                        ${formatPrice(item.subtotal)}
                    </div>
                    <button class="btn btn-sm" style="color: var(--danger-color); background: none; border: none; cursor: pointer;"
                            onclick="removeItem('${item.id}')">
                        Remove
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    document.getElementById('checkout-btn').disabled = false;
}

function displayEmptyCart() {
    const container = document.getElementById('cart-items-container');
    container.innerHTML = `
        <div style="text-align: center; padding: 4rem; background: white; border-radius: var(--radius-lg);">
            <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸ›’</div>
            <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Your cart is empty</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Add some products to get started!</p>
            <a href="/marketplace/products/" class="btn btn-primary">Browse Products</a>
        </div>
    `;
    document.getElementById('checkout-btn').disabled = true;
}

function updateSummary() {
    const subtotal = cartItems.reduce((sum, item) => sum + parseFloat(item.subtotal), 0);
    const delivery = subtotal > 0 ? 50 : 0;
    const tax = subtotal * 0.05;
    const total = subtotal + delivery + tax;
    
    document.getElementById('subtotal').textContent = formatPrice(subtotal);
    document.getElementById('delivery').textContent = formatPrice(delivery);
    document.getElementById('tax').textContent = formatPrice(tax);
    document.getElementById('total').textContent = formatPrice(total);
}

async function updateQuantity(itemId, newQuantity) {
    if (newQuantity < 1) return;
    
    try {
        showLoading();
        await updateCartItem(itemId, newQuantity);
        await loadCart();
        hideLoading();
        showToast('Cart updated', 'success');
        updateCartCount();
    } catch (error) {
        hideLoading();
        showToast('Failed to update cart', 'error');
    }
}

async function removeItem(itemId) {
    if (!confirmAction('Remove this item from cart?')) return;
    
    try {
        showLoading();
        await removeFromCart(itemId);
        await loadCart();
        hideLoading();
        showToast('Item removed', 'success');
        updateCartCount();
    } catch (error) {
        hideLoading();
        showToast('Failed to remove item', 'error');
    }
}

function proceedToCheckout() {
    if (cartItems.length === 0) {
        showToast('Your cart is empty', 'warning');
        return;
    }
    window.location.href = '/marketplace/checkout/';
}
</script>
{% endblock %}
