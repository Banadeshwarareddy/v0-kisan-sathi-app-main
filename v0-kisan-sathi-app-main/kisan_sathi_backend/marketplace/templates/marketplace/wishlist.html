{% extends 'marketplace/base.html' %}
{% load static %}

{% block title %}My Wishlist - Kisan Marketplace{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 0;">
    <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">My Wishlist</h1>
    
    <div id="wishlist-container" class="products-grid">
        <div style="text-align: center; padding: 4rem; grid-column: 1/-1;">
            <div class="spinner"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    await loadWishlist();
});

async function loadWishlist() {
    try {
        showLoading();
        const wishlist = await fetchWishlist();
        hideLoading();
        displayWishlist(wishlist);
    } catch (error) {
        hideLoading();
        console.error('Error loading wishlist:', error);
        showToast('Please login to view wishlist', 'error');
    }
}

function displayWishlist(items) {
    const container = document.getElementById('wishlist-container');
    
    if (!items || items.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 4rem; grid-column: 1/-1;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">‚ô°</div>
                <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Your wishlist is empty</h2>
                <p style="color: var(--text-secondary); margin-bottom: 2rem;">Save products you love for later!</p>
                <a href="/marketplace/products/" class="btn btn-primary">Browse Products</a>
            </div>
        `;
        return;
    }
    
    container.innerHTML = items.map(item => {
        const product = item.product;
        const discount = calculateDiscount(product.original_price, product.price_per_unit);
        
        return `
            <div class="product-card">
                <div style="position: relative;">
                    <img src="${product.primary_image_url || getPlaceholderImage(product.name)}" 
                         alt="${product.name}" 
                         class="product-image"
                         onerror="handleImageError(this)"
                         onclick="window.location.href='/marketplace/products/${product.id}/'">
                    <button style="position: absolute; top: 1rem; right: 1rem; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; box-shadow: var(--shadow-md);"
                            onclick="removeFromWishlistAction('${item.id}')">
                        ‚úï
                    </button>
                </div>
                <div class="product-body">
                    <div class="product-category">${product.category_name || 'Crops'}</div>
                    <h3 class="product-name">${product.name}</h3>
                    <div class="product-farmer">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        ${product.farmer_name || 'Farmer'}
                    </div>
                    
                    ${product.rating > 0 ? `
                        <div class="product-rating">
                            <span class="stars">${formatStars(product.rating)}</span>
                            <span class="rating-count">(${product.review_count})</span>
                        </div>
                    ` : ''}
                    
                    <div class="product-price">
                        <span class="current-price">${formatPrice(product.price_per_unit)}</span>
                        ${product.original_price && discount > 0 ? `
                            <span class="original-price">${formatPrice(product.original_price)}</span>
                            <span class="discount-badge">${discount}% OFF</span>
                        ` : ''}
                    </div>
                    
                    <div class="product-badges">
                        ${product.is_organic_certified ? '<span class="badge-organic">üå± Organic</span>' : ''}
                        ${product.quality_grade === 'premium' ? '<span class="badge-certified">‚≠ê Premium</span>' : ''}
                    </div>
                    
                    <button class="btn btn-primary btn-sm" style="width: 100%;" 
                            onclick="moveToCart('${product.id}', '${product.name}', '${item.id}')">
                        Move to Cart
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

async function removeFromWishlistAction(itemId) {
    try {
        showLoading();
        await removeFromWishlist(itemId);
        await loadWishlist();
        hideLoading();
        showToast('Removed from wishlist', 'success');
    } catch (error) {
        hideLoading();
        showToast('Failed to remove item', 'error');
    }
}

async function moveToCart(productId, productName, wishlistItemId) {
    try {
        showLoading();
        await addToCart(productId, 1);
        await removeFromWishlist(wishlistItemId);
        await loadWishlist();
        hideLoading();
        showToast(`${productName} moved to cart!`, 'success');
        updateCartCount();
    } catch (error) {
        hideLoading();
        showToast('Failed to move to cart', 'error');
    }
}
</script>
{% endblock %}
