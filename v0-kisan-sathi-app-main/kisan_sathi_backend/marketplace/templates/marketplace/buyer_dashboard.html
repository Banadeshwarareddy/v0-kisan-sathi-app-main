{% extends 'marketplace/base.html' %}
{% load static %}

{% block title %}My Orders - Kisan Marketplace{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 0;">
    <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">My Orders</h1>
    
    <!-- Filter Tabs -->
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <button class="filter-tab active" onclick="filterOrders('all')">All Orders</button>
        <button class="filter-tab" onclick="filterOrders('pending')">Pending</button>
        <button class="filter-tab" onclick="filterOrders('confirmed')">Confirmed</button>
        <button class="filter-tab" onclick="filterOrders('shipped')">Shipped</button>
        <button class="filter-tab" onclick="filterOrders('delivered')">Delivered</button>
        <button class="filter-tab" onclick="filterOrders('cancelled')">Cancelled</button>
    </div>
    
    <!-- Orders List -->
    <div id="orders-container">
        <div style="text-align: center; padding: 4rem;">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<style>
.filter-tab {
    padding: 0.75rem 1.5rem;
    border: 2px solid var(--border-color);
    background: white;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.filter-tab:hover {
    border-color: var(--primary-color);
}

.filter-tab.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.order-card {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: 2rem;
    margin-bottom: 1.5rem;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 999px;
    font-size: 0.875rem;
    font-weight: 600;
}

.status-pending { background: #fef3c7; color: #92400e; }
.status-confirmed { background: #dbeafe; color: #1e40af; }
.status-shipped { background: #e0e7ff; color: #3730a3; }
.status-delivered { background: #dcfce7; color: #166534; }
.status-cancelled { background: #fee2e2; color: #991b1b; }
</style>

{% endblock %}

{% block extra_js %}
<script>
let allOrders = [];
let currentFilter = 'all';

document.addEventListener('DOMContentLoaded', async () => {
    await loadOrders();
});

async function loadOrders() {
    try {
        showLoading();
        const response = await fetchOrders();
        allOrders = response.results || [];
        hideLoading();
        displayOrders();
    } catch (error) {
        hideLoading();
        console.error('Error loading orders:', error);
        showToast('Please login to view orders', 'error');
        setTimeout(() => window.location.href = '/login/', 2000);
    }
}

function displayOrders() {
    const container = document.getElementById('orders-container');
    
    let filteredOrders = allOrders;
    if (currentFilter !== 'all') {
        filteredOrders = allOrders.filter(o => o.order_status === currentFilter);
    }
    
    if (filteredOrders.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 4rem; background: white; border-radius: var(--radius-lg);">
                <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸ“¦</div>
                <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">No orders found</h2>
                <p style="color: var(--text-secondary); margin-bottom: 2rem;">Start shopping to see your orders here!</p>
                <a href="/marketplace/products/" class="btn btn-primary">Browse Products</a>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filteredOrders.map(order => `
        <div class="order-card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                <div>
                    <div style="font-weight: 700; font-size: 1.125rem; margin-bottom: 0.5rem;">
                        Order #${order.order_number}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">
                        Placed on ${formatDate(order.created_at)}
                    </div>
                </div>
                <span class="status-badge status-${order.order_status}">
                    ${order.order_status.replace('_', ' ').toUpperCase()}
                </span>
            </div>
            
            <div style="display: flex; gap: 1.5rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                <img src="${order.product?.primary_image_url || getPlaceholderImage('Product')}" 
                     style="width: 100px; height: 100px; object-fit: cover; border-radius: var(--radius-md);"
                     onerror="handleImageError(this)">
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem;">
                        ${order.product_name || 'Product'}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">
                        Farmer: ${order.farmer_name || 'N/A'}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">
                        Quantity: ${order.quantity_ordered} ${order.unit}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 700; font-size: 1.25rem; color: var(--primary-color); margin-bottom: 0.5rem;">
                        ${formatPrice(order.total_amount)}
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        ${order.payment_status}
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="color: var(--text-secondary); font-size: 0.875rem;">
                    ${order.tracking_number ? `Tracking: ${order.tracking_number}` : ''}
                    ${order.estimated_delivery_date ? `<br>Expected: ${formatDate(order.estimated_delivery_date)}` : ''}
                </div>
                <div style="display: flex; gap: 1rem;">
                    ${order.order_status === 'pending' || order.order_status === 'confirmed' ? `
                        <button class="btn btn-sm" style="background: var(--danger-color); color: white;" 
                                onclick="cancelOrderAction('${order.id}')">
                            Cancel Order
                        </button>
                    ` : ''}
                    ${order.order_status === 'delivered' ? `
                        <button class="btn btn-primary btn-sm" onclick="alert('Review feature coming soon!')">
                            Write Review
                        </button>
                    ` : ''}
                    <button class="btn btn-outline btn-sm" onclick="viewOrderDetails('${order.id}')">
                        View Details
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function filterOrders(status) {
    currentFilter = status;
    document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    displayOrders();
}

async function cancelOrderAction(orderId) {
    const reason = prompt('Please provide a reason for cancellation:');
    if (!reason) return;
    
    try {
        showLoading();
        await cancelOrder(orderId, reason);
        await loadOrders();
        hideLoading();
        showToast('Order cancelled successfully', 'success');
    } catch (error) {
        hideLoading();
        showToast('Failed to cancel order', 'error');
    }
}

function viewOrderDetails(orderId) {
    alert(`Order details page coming soon! Order ID: ${orderId}`);
}
</script>
{% endblock %}
