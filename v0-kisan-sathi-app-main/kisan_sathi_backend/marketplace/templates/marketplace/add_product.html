{% extends 'marketplace/base.html' %}
{% load static %}

{% block title %}Add Product - Kisan Marketplace{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 0; max-width: 800px;">
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
        <a href="{% url 'marketplace:farmer_dashboard' %}" style="color: var(--text-secondary); text-decoration: none;">
            ← Back to Dashboard
        </a>
    </div>
    
    <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">Add New Product</h1>
    
    <div style="background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); padding: 2rem;">
        <form id="add-product-form" enctype="multipart/form-data">
            <!-- Basic Information -->
            <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary-color);">
                    Basic Information
                </h3>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Product Name *</label>
                    <input type="text" name="name" required 
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);"
                           placeholder="e.g., Organic Tomatoes">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Category *</label>
                    <select name="category_id" required id="category-select"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                        <option value="">Select Category</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Variety</label>
                    <input type="text" name="variety" 
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);"
                           placeholder="e.g., Cherry, Roma">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Description</label>
                    <textarea name="description" rows="4"
                              style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);"
                              placeholder="Describe your product..."></textarea>
                </div>
            </div>
            
            <!-- Pricing & Inventory -->
            <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary-color);">
                    Pricing & Inventory
                </h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Price per Unit (₹) *</label>
                        <input type="number" name="price_per_unit" required step="0.01" min="0"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Original Price (₹)</label>
                        <input type="number" name="original_price" step="0.01" min="0"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Quantity Available *</label>
                        <input type="number" name="quantity_available" required step="0.001" min="0"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Unit *</label>
                        <select name="unit" required
                                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                            <option value="kg">Kilogram (kg)</option>
                            <option value="gram">Gram</option>
                            <option value="quintal">Quintal</option>
                            <option value="ton">Ton</option>
                            <option value="piece">Piece</option>
                            <option value="dozen">Dozen</option>
                            <option value="bag_25kg">Bag (25kg)</option>
                            <option value="bag_50kg">Bag (50kg)</option>
                            <option value="litre">Litre</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Min Order Quantity</label>
                        <input type="number" name="min_order_quantity" step="0.001" min="0" value="1"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Max Order Quantity</label>
                        <input type="number" name="max_order_quantity" step="0.001" min="0"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    </div>
                </div>
            </div>
            
            <!-- Quality & Certifications -->
            <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary-color);">
                    Quality & Certifications
                </h3>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Quality Grade</label>
                    <select name="quality_grade"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                        <option value="">Select Grade</option>
                        <option value="premium">Premium</option>
                        <option value="grade_a">Grade A</option>
                        <option value="grade_b">Grade B</option>
                        <option value="grade_c">Grade C</option>
                        <option value="standard">Standard</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="is_organic_certified" value="true">
                        <span style="font-weight: 600;">Organic Certified</span>
                    </label>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="is_fssai_approved" value="true">
                        <span style="font-weight: 600;">FSSAI Approved</span>
                    </label>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Harvest Date</label>
                        <input type="date" name="harvest_date"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Manufacturing Date</label>
                        <input type="date" name="manufacturing_date"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Expiry Date</label>
                        <input type="date" name="expiry_date"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    </div>
                </div>
            </div>
            
            <!-- Product Images -->
            <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary-color);">
                    Product Images
                </h3>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Primary Image *</label>
                    <input type="file" name="primary_image" accept="image/*" required id="primary-image-input"
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    <div id="primary-image-preview" style="margin-top: 1rem;"></div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Additional Images (Optional)</label>
                    <input type="file" name="additional_images" accept="image/*" multiple id="additional-images-input"
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        You can select multiple images (up to 5)
                    </p>
                    <div id="additional-images-preview" style="margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem;"></div>
                </div>
            </div>
            
            <!-- Listing Status -->
            <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary-color);">
                    Listing Status
                </h3>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Status *</label>
                    <select name="listing_status" required
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                        <option value="draft">Draft (Not visible to buyers)</option>
                        <option value="active">Active (Visible to buyers)</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            
            <!-- Submit Buttons -->
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <a href="{% url 'marketplace:farmer_dashboard' %}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary" id="submit-btn">
                    <span id="submit-text">Add Product</span>
                    <span id="submit-loading" style="display: none;">Adding...</span>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.image-preview {
    position: relative;
    display: inline-block;
}

.image-preview img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: var(--radius-md);
    border: 2px solid var(--border-color);
}

.image-preview-remove {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--danger-color);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 14px;
    line-height: 1;
}
</style>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    await loadCategories();
    setupImagePreviews();
});

async function loadCategories() {
    try {
        const response = await fetchCategories();
        const categories = response.results || [];
        
        const select = document.getElementById('category-select');
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading categories:', error);
        showToast('Failed to load categories', 'error');
    }
}

function setupImagePreviews() {
    // Primary image preview
    document.getElementById('primary-image-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('primary-image-preview').innerHTML = `
                    <div class="image-preview">
                        <img src="${e.target.result}" alt="Primary image preview">
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Additional images preview
    document.getElementById('additional-images-input').addEventListener('change', function(e) {
        const files = Array.from(e.target.files).slice(0, 5); // Max 5 images
        const container = document.getElementById('additional-images-preview');
        container.innerHTML = '';
        
        files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'image-preview';
                div.innerHTML = `
                    <img src="${e.target.result}" alt="Additional image ${index + 1}">
                `;
                container.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    });
}

document.getElementById('add-product-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitLoading = document.getElementById('submit-loading');
    
    try {
        submitBtn.disabled = true;
        submitText.style.display = 'none';
        submitLoading.style.display = 'inline';
        
        const formData = new FormData(this);
        
        // Convert checkboxes to boolean
        formData.set('is_organic_certified', formData.get('is_organic_certified') === 'true');
        formData.set('is_fssai_approved', formData.get('is_fssai_approved') === 'true');
        
        // Handle additional images
        const additionalImagesInput = document.getElementById('additional-images-input');
        if (additionalImagesInput.files.length > 0) {
            // Remove the default additional_images field
            formData.delete('additional_images');
            // Add each file individually
            Array.from(additionalImagesInput.files).forEach((file, index) => {
                formData.append('additional_images', file);
            });
        }
        
        const response = await fetch('/api/marketplace/products/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: formData
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to add product');
        }
        
        const data = await response.json();
        showToast('Product added successfully!', 'success');
        
        // Redirect to farmer dashboard after 1 second
        setTimeout(() => {
            window.location.href = '{% url "marketplace:farmer_dashboard" %}';
        }, 1000);
        
    } catch (error) {
        console.error('Error adding product:', error);
        showToast(error.message || 'Failed to add product', 'error');
        submitBtn.disabled = false;
        submitText.style.display = 'inline';
        submitLoading.style.display = 'none';
    }
});
</script>
{% endblock %}
